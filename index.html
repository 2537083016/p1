<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Presensi Wajah ‚Äì Two Stage (Responsive)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial;
  background:#f4f6f8;
  margin:0;
  padding:16px;
}

h2,h3{margin:8px 0}

.container{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:16px;
}

.card{
  background:#fff;
  padding:12px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}

.video-area{
  text-align:center;
}

canvas{
  width:100%;
  max-width:480px;
  aspect-ratio:4/3;
  border:1px solid #888;
}

button,input{
  padding:6px;
  margin:4px;
}

table{
  border-collapse:collapse;
  width:100%;
  font-size:13px;
}

th,td{
  border:1px solid #bbb;
  padding:5px;
  text-align:center;
}

th{background:#eee}

.bar svg{width:140px;height:16px}
.match{color:#4CAF50;font-weight:bold}
.nomatch{color:#F44336;font-weight:bold}

@media(max-width:900px){
  .container{
    grid-template-columns:1fr;
  }
}
</style>
</head>

<body>

<h2>üì∑ Presensi Wajah ‚Äì Two-Stage Matching</h2>

<div class="container">

<!-- ===== LEFT ===== -->
<div class="card video-area">

<!-- VIDEO OFFSCREEN (AMAN) -->
<video id="video" autoplay muted playsinline
style="
  position:absolute;
  left:-10000px;
  top:-10000px;
  width:160px;
  height:120px;
  opacity:0;
"></video>

<canvas id="canvas" width="320" height="240"></canvas><br>

<input id="nama" placeholder="Nama">
<button onclick="enroll()">Daftar</button><br>

<button onclick="startScan()">‚ñ∂ Start</button>
<button onclick="stopScan()">‚èπ Stop</button>

<div id="status"><b>Status:</b> idle</div>

</div>

<!-- ===== RIGHT ===== -->
<div class="card">

<h3>üìä Ranking Kemiripan</h3>
<table>
<thead>
<tr><th>Nama</th><th>%</th><th>Bar</th><th>Status</th></tr>
</thead>
<tbody id="rankTable"></tbody>
</table>

<h3>üî¨ Faktor Evaluasi</h3>
<table>
<tr><td>ROI</td><td id="fROI">-</td></tr>
<tr><td>Dimensi</td><td id="fDim">-</td></tr>
<tr><td>Mean</td><td id="fMean">-</td></tr>
<tr><td>Top-1</td><td id="fTop1">-</td></tr>
<tr><td>Dataset</td><td id="fSize">-</td></tr>
<tr><td>FPS</td><td id="fFPS">-</td></tr>
<tr><td>Keputusan</td><td id="fDecision">-</td></tr>
</table>

</div>

</div>

<h3>üìã Log Presensi</h3>
<table>
<thead><tr><th>Nama</th><th>%</th><th>Waktu</th></tr></thead>
<tbody id="log"></tbody>
</table>

<script src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
let video=document.getElementById("video");
let canvas=document.getElementById("canvas");
let ctx=canvas.getContext("2d",{willReadFrequently:true});
let classifier, scanning=false;
let lastFrame=performance.now(), lastPresensi=0;

const THRESHOLD=0.85, DELAY=3000, TOP_K=5;

/* CAMERA */
async function initCamera(){
  const s=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=s;
  await new Promise(r=>video.onloadedmetadata=r);
  video.play();
}

/* FACE */
function getFace(){
  ctx.drawImage(video,0,0,320,240);
  let src=cv.imread(canvas);
  let gray=new cv.Mat();
  cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);

  let faces=new cv.RectVector();
  classifier.detectMultiScale(gray,faces,1.3,5);
  if(faces.size()===0){
    src.delete();gray.delete();faces.delete();
    return null;
  }

  let r=faces.get(0);
  ctx.strokeStyle="lime";ctx.lineWidth=2;
  ctx.strokeRect(r.x,r.y,r.width,r.height);

  let roi=gray.roi(r).clone();
  cv.resize(roi,roi,new cv.Size(50,50));

  let vec=Array.from(roi.data);
  let mean=vec.reduce((a,b)=>a+b,0)/vec.length;

  fROI.innerText=`${r.width}√ó${r.height}`;
  fDim.innerText=vec.length;
  fMean.innerText=mean.toFixed(2);

  src.delete();gray.delete();faces.delete();roi.delete();
  return {vec,mean};
}

/* COSINE */
function cosine(a,b){
  let d=0,na=0,nb=0;
  for(let i=0;i<a.length;i++){
    d+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i];
  }
  if(na===0||nb===0) return 0;
  return d/(Math.sqrt(na)*Math.sqrt(nb));
}

/* ENROLL */
function enroll(){
  let n=nama.value;
  if(!n) return alert("Isi nama");
  let f=getFace();
  if(!f) return alert("Wajah tidak terdeteksi");
  let db=JSON.parse(localStorage.getItem("faces")||"{}");
  db[n]=f;
  localStorage.setItem("faces",JSON.stringify(db));
  alert("Wajah tersimpan");
}

/* VERIFY */
function verifyAll(input){
  let db=JSON.parse(localStorage.getItem("faces")||"{}");
  let coarse=[],res=[];
  for(let n in db)
    coarse.push({n,d:Math.abs(input.mean-db[n].mean)});
  coarse.sort((a,b)=>a.d-b.d);
  coarse.slice(0,TOP_K).forEach(c=>{
    res.push({nama:c.n,score:cosine(input.vec,db[c.n].vec)});
  });
  fSize.innerText=Object.keys(db).length;
  return res.sort((a,b)=>b.score-a.score);
}

/* LOOP */
function loop(){
  if(!scanning) return;
  let now=performance.now();
  fFPS.innerText=(1000/(now-lastFrame)).toFixed(1);
  lastFrame=now;

  let f=getFace();
  if(f){
    let r=verifyAll(f);
    updateRanking(r);
    if(r[0]){
      fTop1.innerText=(r[0].score*100).toFixed(2)+"%";
      let ok=r[0].score>THRESHOLD;
      fDecision.innerText=ok?"MATCH":"NO MATCH";
      fDecision.className=ok?"match":"nomatch";
      if(ok) presensi(r[0]);
    }
  }
  requestAnimationFrame(loop);
}

/* UI */
function updateRanking(r){
  rankTable.innerHTML="";
  r.forEach(e=>{
    let p=(e.score*100).toFixed(1);
    rankTable.innerHTML+=`
    <tr>
      <td>${e.nama}</td>
      <td>${p}</td>
      <td class="bar"><svg>
        <rect width="${1.4*p}" height="16" fill="${p>85?"#4CAF50":"#F44336"}"/>
      </svg></td>
      <td class="${p>85?"match":"nomatch"}">${p>85?"MATCH":"NO"}</td>
    </tr>`;
  });
}

function presensi(r){
  let now=Date.now();
  if(now-lastPresensi<DELAY) return;
  lastPresensi=now;
  log.innerHTML+=`<tr><td>${r.nama}</td><td>${(r.score*100).toFixed(2)}</td><td>${new Date().toLocaleString()}</td></tr>`;
}

function startScan(){scanning=true;status.innerText="Status: scanning";loop();}
function stopScan(){scanning=false;status.innerText="Status: stopped";}

/* INIT */
cv.onRuntimeInitialized=async()=>{
  await initCamera();
  classifier=new cv.CascadeClassifier();
  let r=await fetch("https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml");
  let d=new Uint8Array(await r.arrayBuffer());
  cv.FS_createDataFile("/", "face.xml", d, true, false, false);
  classifier.load("face.xml");
  console.log("OpenCV Ready");
};
</script>

</body>
</html>
