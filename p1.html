<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Face Attendance OpenCV.js (Single File)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:system-ui;background:#f9fafb;margin:16px;color:#111}
h2{margin:0 0 8px}
.panel{background:#fff;border:1px solid #d1d5db;border-radius:10px;padding:10px;margin-bottom:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
button{padding:6px 12px;border-radius:8px;border:1px solid #2563eb;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
button.secondary{background:#fff;color:#111;border:1px solid #d1d5db}
input,select{padding:6px;border-radius:6px;border:1px solid #d1d5db}
table{border-collapse:collapse;width:100%;font-size:13px}
th,td{border:1px solid #d1d5db;padding:4px;text-align:left}
canvas{border:1px solid #d1d5db;border-radius:8px}
svg{width:100%;height:200px;border:1px solid #d1d5db;border-radius:8px}
.muted{color:#6b7280;font-size:12px}
</style>
</head>

<body>
<h2>Presensi Wajah Realtime – OpenCV.js (WASM)</h2>

<div class="panel">
  <div class="row">
    <button id="start">Start Scan</button>
    <button id="activate" class="secondary" disabled>Aktifkan Kembali</button>
    <input id="name" placeholder="Nama Enroll">
    <button id="enroll" class="secondary">Enroll</button>
  </div>
  <p id="status" class="muted">Memuat OpenCV.js…</p>
</div>

<div class="panel row">
  <video id="video" autoplay muted playsinline width="320"></video>
  <canvas id="canvas" width="320" height="240"></canvas>
</div>

<div class="panel">
<h3>Dataset Presensi</h3>
<table>
<thead><tr><th>Nama</th><th>Waktu</th></tr></thead>
<tbody id="attendance"></tbody>
</table>
</div>

<div class="panel">
<h3>Benchmark Konversi Image</h3>
<table>
<thead><tr><th>Metode</th><th>Waktu (ms)</th></tr></thead>
<tbody id="benchTable"></tbody>
</table>
<svg id="chart"></svg>
</div>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const DB_KEY="faces_db";
const ATT_KEY="attendance_db";

let classifier, running=false, scanStop=false;
let benchmark={base64:0,uint8:0,bitmap:0};

/* ===== LOCAL STORAGE ===== */
const loadFaces=()=>JSON.parse(localStorage.getItem(DB_KEY)||"[]");
const saveFaces=d=>localStorage.setItem(DB_KEY,JSON.stringify(d));
const loadAtt=()=>JSON.parse(localStorage.getItem(ATT_KEY)||"[]");
const saveAtt=d=>localStorage.setItem(ATT_KEY,JSON.stringify(d));

/* ===== FEATURE EXTRACTION (Histogram) ===== */
function extractFeature(mat){
  let gray=new cv.Mat();
  cv.cvtColor(mat,gray,cv.COLOR_RGBA2GRAY);
  let hist=new cv.Mat();
  cv.calcHist(gray,[0],new cv.Mat(),hist,[64],[0,256]);
  cv.normalize(hist,hist);
  gray.delete();
  return Array.from(hist.data32F);
}

/* ===== COSINE ===== */
function cosine(a,b){
  let d=0,na=0,nb=0;
  for(let i=0;i<a.length;i++){d+=a[i]*b[i];na+=a[i]*a[i];nb+=b[i]*b[i]}
  return d/(Math.sqrt(na)*Math.sqrt(nb)+1e-9);
}

/* ===== BENCHMARK ===== */
async function benchmarkAll(){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  let t0=performance.now();
  let img=new Image();
  img.src=canvas.toDataURL();
  await img.decode();
  ctx.drawImage(img,0,0);
  cv.imread(canvas).delete();
  benchmark.base64=performance.now()-t0;

  t0=performance.now();
  let id=ctx.getImageData(0,0,canvas.width,canvas.height);
  cv.matFromImageData(id).delete();
  benchmark.uint8=performance.now()-t0;

  t0=performance.now();
  let bmp=await createImageBitmap(video);
  ctx.drawImage(bmp,0,0);
  cv.imread(canvas).delete();
  benchmark.bitmap=performance.now()-t0;

  renderBenchmark();
}

/* ===== RENDER BENCH ===== */
function renderBenchmark(){
  const tbody=document.getElementById("benchTable");
  tbody.innerHTML="";
  Object.entries(benchmark).forEach(([k,v])=>{
    tbody.innerHTML+=`<tr><td>${k}</td><td>${v.toFixed(2)}</td></tr>`;
  });

  const svg=document.getElementById("chart");
  while(svg.firstChild) svg.removeChild(svg.firstChild);

  const vals=Object.values(benchmark);
  const max=Math.max(...vals);
  const keys=Object.keys(benchmark);
  keys.forEach((k,i)=>{
    const h=180*(benchmark[k]/max);
    let r=document.createElementNS("http://www.w3.org/2000/svg","rect");
    r.setAttribute("x",40+i*90);
    r.setAttribute("y",190-h);
    r.setAttribute("width",40);
    r.setAttribute("height",h);
    r.setAttribute("fill","#2563eb");
    svg.appendChild(r);
  });
}

/* ===== MAIN LOOP ===== */
function loop(){
  if(!running||scanStop) return;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  let src=cv.imread(canvas);
  let gray=new cv.Mat();
  cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  let faces=new cv.RectVector();
  classifier.detectMultiScale(gray,faces);

  if(faces.size()>0){
    let r=faces.get(0);
    let roi=src.roi(r);
    let feat=extractFeature(roi);
    let best={name:null,score:0};
    loadFaces().forEach(f=>{
      let s=cosine(feat,f.feat);
      if(s>best.score) best={name:f.name,score:s};
    });

    if(best.score>0.9){
      scanStop=true;
      let att=loadAtt();
      att.push({name:best.name,time:new Date().toLocaleString()});
      saveAtt(att);
      renderAttendance();
      document.getElementById("activate").disabled=false;
      document.getElementById("status").textContent="Presensi berhasil: "+best.name;
    }
    roi.delete();
  }
  src.delete();gray.delete();faces.delete();
  requestAnimationFrame(loop);
}

/* ===== RENDER ATT ===== */
function renderAttendance(){
  const tb=document.getElementById("attendance");
  tb.innerHTML="";
  loadAtt().forEach(a=>{
    tb.innerHTML+=`<tr><td>${a.name}</td><td>${a.time}</td></tr>`;
  });
}

/* ===== BUTTONS ===== */
document.getElementById("start").onclick=async()=>{
  let stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;
  running=true;scanStop=false;
  benchmarkAll();
  loop();
};

document.getElementById("activate").onclick=()=>{
  scanStop=false;
  document.getElementById("activate").disabled=true;
  loop();
};

document.getElementById("enroll").onclick=()=>{
  let n=document.getElementById("name").value.trim();
  if(!n) return alert("Isi nama");
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  let src=cv.imread(canvas);
  let feat=extractFeature(src);
  let db=loadFaces();
  db.push({name:n,feat});
  saveFaces(db);
  src.delete();
  alert("Enroll berhasil");
};

/* ===== INIT OPENCV ===== */
cv.onRuntimeInitialized=async()=>{
  const res=await fetch("https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml");
  const buf=new Uint8Array(await res.arrayBuffer());
  cv.FS_createDataFile("/", "face.xml", buf, true, false);
  classifier=new cv.CascadeClassifier();
  classifier.load("face.xml");
  document.getElementById("status").textContent="OpenCV.js siap";
  renderAttendance();
};
</script>
</body>
</html>
