<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Face Attendance – Real-time FIXED</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>

<body class="bg-slate-100 min-h-screen p-4">

<div class="max-w-6xl mx-auto space-y-6">

<header class="bg-white rounded-xl shadow p-4">
  <h1 class="text-2xl font-bold">Face Attendance System</h1>
  <p class="text-sm text-gray-500">Real-time Verification · OpenCV.js</p>
</header>

<section class="bg-white rounded-xl shadow p-4">
  <h2 class="font-semibold mb-2">Live Camera</h2>

  <div class="grid md:grid-cols-2 gap-4">
    <video id="video" autoplay muted class="rounded border"></video>

    <div class="space-y-2">
      <input id="nameInput" placeholder="Nama"
        class="w-full border rounded px-3 py-2">

      <button onclick="registerFace()"
        class="w-full bg-blue-600 text-white py-2 rounded">
        Register Face
      </button>

      <button onclick="startScan()"
        class="w-full bg-green-600 text-white py-2 rounded">
        Start Scan
      </button>

      <button onclick="stopScan()"
        class="w-full bg-red-500 text-white py-2 rounded">
        Stop Scan
      </button>
    </div>
  </div>
</section>

<section class="bg-white rounded-xl shadow p-4">
  <h2 class="font-semibold mb-2">Attendance Log</h2>
  <div id="attendanceList" class="space-y-2 text-sm"></div>
</section>

<section class="bg-white rounded-xl shadow p-4">
  <div class="flex justify-between items-center">
    <h2 class="font-semibold">Performance Benchmark</h2>
    <button onclick="runBenchmark()"
      class="bg-purple-600 text-white px-4 py-2 rounded">
      Run Benchmark
    </button>
  </div>

  <table class="w-full text-sm mt-4 border">
    <thead class="bg-gray-200">
      <tr>
        <th class="border p-2">Method</th>
        <th class="border p-2">Execution Time (ms)</th>
      </tr>
    </thead>
    <tbody id="benchmarkTable"></tbody>
  </table>

  <canvas id="benchmarkChart" height="120"></canvas>
</section>

</div>

<script>
/* ================= GLOBAL ================= */
let video = document.getElementById("video");
let canvas = document.createElement("canvas");
let ctx = canvas.getContext("2d");

let cap, classifier;
let scanning = false;

let facesDB = JSON.parse(localStorage.getItem("faces-db-v1")) || [];
let attendanceDB = JSON.parse(localStorage.getItem("attendance-db-v1")) || [];

/* ================= CAMERA ================= */
navigator.mediaDevices.getUserMedia({ video: true })
.then(s => video.srcObject = s);

/* ================= OPENCV INIT ================= */
function waitCV() {
  if (cv && cv.Mat) initCV();
  else setTimeout(waitCV, 100);
}
waitCV();

function initCV() {
  cap = new cv.VideoCapture(video);
  classifier = new cv.CascadeClassifier();
  classifier.load(
   "https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml"
  );
}

/* ================= FEATURE ================= */
function extractHist(gray) {
  let hist = new cv.Mat();
  cv.calcHist(gray, [0], new cv.Mat(), hist, [32], [0,256]);
  cv.normalize(hist, hist);
  return Array.from(hist.data32F);
}

/* ================= REGISTER ================= */
function registerFace() {
  if (!nameInput.value) return alert("Nama kosong");

  let mat = captureFace();
  if (!mat) return alert("Wajah tidak terdeteksi");

  facesDB.push({
    id: crypto.randomUUID(),
    name: nameInput.value,
    hist: extractHist(mat)
  });

  localStorage.setItem("faces-db-v1", JSON.stringify(facesDB));
  mat.delete();
  alert("Wajah tersimpan");
}

/* ================= REAL-TIME LOOP ================= */
function startScan() {
  scanning = true;
  requestAnimationFrame(processFrame);
}
function stopScan() { scanning = false; }

function processFrame() {
  if (!scanning) return;

  let face = captureFace();
  if (face) {
    let hist = extractHist(face);
    let best = { score: -1, name: null };

    facesDB.forEach(d => {
      let s = cv.compareHist(
        cv.matFromArray(32,1,cv.CV_32F,hist),
        cv.matFromArray(32,1,cv.CV_32F,d.hist),
        cv.HISTCMP_CORREL
      );
      if (s > best.score) best = { score: s, name: d.name };
    });

    if (best.score > 0.8) {
      scanning = false;
      attendanceDB.push({
        name: best.name,
        time: new Date().toLocaleString()
      });
      localStorage.setItem(
        "attendance-db-v1", JSON.stringify(attendanceDB));
      renderAttendance();
      alert("Presensi berhasil: " + best.name);
    }
    face.delete();
  }
  requestAnimationFrame(processFrame);
}

/* ================= FACE CAPTURE ================= */
function captureFace() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);

  let src = cv.imread(canvas);
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

  let faces = new cv.RectVector();
  classifier.detectMultiScale(gray, faces);

  if (faces.size() === 0) {
    src.delete(); gray.delete(); faces.delete();
    return null;
  }

  let roi = gray.roi(faces.get(0));
  src.delete(); gray.delete(); faces.delete();
  return roi;
}

/* ================= ATTENDANCE UI ================= */
function renderAttendance() {
  attendanceList.innerHTML = "";
  attendanceDB.forEach(a => {
    let d = document.createElement("div");
    d.className = "border p-2 rounded";
    d.textContent = `${a.name} – ${a.time}`;
    attendanceList.appendChild(d);
  });
}
renderAttendance();

/* ================= BENCHMARK ================= */
async function runBenchmark() {
  let res = [];
  let t0, t1;

  t0 = performance.now();
  canvas.toDataURL();
  t1 = performance.now();
  res.push({n:"Base64",t:t1-t0});

  t0 = performance.now();
  ctx.getImageData(0,0,canvas.width,canvas.height);
  t1 = performance.now();
  res.push({n:"Uint8Array",t:t1-t0});

  t0 = performance.now();
  await createImageBitmap(video);
  t1 = performance.now();
  res.push({n:"ImageBitmap",t:t1-t0});

  renderBenchmark(res);
}

let chart;
function renderBenchmark(r) {
  benchmarkTable.innerHTML="";
  r.forEach(x=>{
    benchmarkTable.innerHTML +=
      `<tr><td class="border p-2">${x.n}</td>
       <td class="border p-2">${x.t.toFixed(2)}</td></tr>`;
  });

  if (chart) chart.destroy();
  chart = new Chart(benchmarkChart, {
    type: "bar",
    data: {
      labels: r.map(x=>x.n),
      datasets: [{
        label: "Execution Time (ms)",
        data: r.map(x=>x.t)
      }]
    }
  });
}
</script>
</body>
</html>
